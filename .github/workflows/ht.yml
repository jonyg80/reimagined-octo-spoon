name: HT CI

on:
  workflow_dispatch:
  # schedule:
  #   - cron: "14 2,10,18 * * *"
  push:
    paths: [.github/workflows/ht.yml]
    branches: [main]

concurrency:
  group: ht

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - repo: "ht-num"
            vid_url: "video?o=ht"
            token: WEB3_TOKEN

    steps:
      - uses: actions/checkout@v2

      - name: Set up Python 3.10
        uses: actions/setup-python@v2
        with:
          python-version: "3.10"

      - name: install requirements
        run: |
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp
          sudo apt update 
          sudo apt install ffmpeg
          sudo npm i -g @mehulagg/w3

      - name: install ipfs
        run: |
          wget https://github.com/ipfs/go-ipfs/releases/download/v0.10.0/go-ipfs_v0.10.0_linux-amd64.tar.gz
          tar -xvzf go-ipfs_v0.10.0_linux-amd64.tar.gz
          cd go-ipfs
          sudo bash install.sh
          ipfs --version
          ipfs init

      - run: git clone https://github.com/jonyg80/${{ matrix.repo }}.git

      - name: run script
        env:
          REPO_DIR: /home/runner/work/reimagined-octo-spoon/reimagined-octo-spoon/${{ matrix.repo }}
        run: |
          cd ${{ matrix.repo }}
          for ((START = $(cat num.txt) ; START <= 701 ;)); do 
            cd $REPO_DIR
            echo "**#* START = ${START}  *#**"
            VID_NUM=$START
            END=$(($START+10))
            yt-dlp -i --playlist-start=${START} --playlist-end=${END} --write-thumbnail --external-downloader=aria2c -o "%(id)s/%(title)s-%(id)s.%(ext)s" \
            --exec ( VID_ID="%(id)s" ) \
            --exec CID=$(ipfs add --cid-version 1 --pin=false --quieter --trickle --recursive "./$VID_ID") --exec \
            ( echo "CID = ${CID}" ) --exec \
            (ipfs dag export --progress=false -- ${CID} > "./$VID_ID.car") --exec \
            (w3 put-car "./$VID_ID.car" --token ${{ secrets[matrix.token] }}) --exec \
            (echo $VID_NUM > $REPO_DIR/num.txt) --exec \
            (git config user.name "jonyg80") --exec \
            (git config user.email "${{ secrets.GIT_EMAIL }}") --exec \
            (git add $REPO_DIR/num.txt) --exec \
            (git commit -m "increment $START") --exec \
            (git push https://jonyg80:${{ secrets.GIT_TOKEN }}@github.com/jonyg80/${{ matrix.repo }}.git main) --exec \
            (rm -r "./$VID_ID") --exec \
            (rm "./$VID_ID.car") --exec \
            (ipfs repo gc) --exec \
            (VID_NUM=$(($VID_NUM+1))) -- "${{ secrets.URL }}/${{ matrix.vid_url }}"
            START=$(($START+10))
            
            if (( $START >= 700))
            then
              START=1
            fi
            df -h
          done
